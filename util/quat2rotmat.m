function [R, dR] = quat2rotmat(q)

% if isnumeric(q)
%   q=q/sqrt(q'*q);  % was norm
% end
q = q / sqrt(q'*q);

% epsilon = 1e-6;
% if isnumeric(q) && abs(q.' * q - 1) > epsilon^2
%   error('q is not a unit quaternion')
% end


w=q(1); x=q(2); y=q(3); z=q(4);

R = [...
  w*w + x*x - y*y - z*z, 2*x*y - 2*w*z, 2*x*z + 2*w*y;
  2*x*y + 2*w*z,  w*w + y*y - x*x - z*z, 2*y*z - 2*w*x;
  2*x*z - 2*w*y, 2*y*z + 2*w*x, w*w + z*z - x*x - y*y];

compute_gradient = nargout > 1;
if compute_gradient
  % gradient without normalization:
%   dR = [...
%     2*w,  2*x, -2*y, -2*z;
%     2*z,  2*y,  2*x,  2*w;
%     -2*y,  2*z, -2*w,  2*x;
%     -2*z,  2*y,  2*x, -2*w;
%     2*w, -2*x,  2*y, -2*z;
%     2*x,  2*w,  2*z,  2*y;
%     2*y,  2*z,  2*w,  2*x;
%     -2*x, -2*w,  2*z,  2*y;
%     2*w, -2*x, -2*y,  2*z];

  dR = reshape([w.*(y.^2+z.^2).*1.0./(w.^2+x.^2+y.^2+z.^2).^2.*4.0,1.0./(w.^2+x.^2+y.^2+z.^2).^2.*(-w.^2.*z+x.^2.*z+y.^2.*z+z.^3-w.*x.*y.*2.0).*2.0,1.0./(w.^2+x.^2+y.^2+z.^2).^2.*(-w.^2.*y+x.^2.*y+y.*z.^2+y.^3+w.*x.*z.*2.0).*-2.0,1.0./(w.^2+x.^2+y.^2+z.^2).^2.*(-w.^2.*z+x.^2.*z+y.^2.*z+z.^3+w.*x.*y.*2.0).*-2.0,w.*(x.^2+z.^2).*1.0./(w.^2+x.^2+y.^2+z.^2).^2.*4.0,1.0./(w.^2+x.^2+y.^2+z.^2).^2.*(-w.^2.*x+x.*y.^2+x.*z.^2+x.^3-w.*y.*z.*2.0).*2.0,1.0./(w.^2+x.^2+y.^2+z.^2).^2.*(-w.^2.*y+x.^2.*y+y.*z.^2+y.^3-w.*x.*z.*2.0).*2.0,1.0./(w.^2+x.^2+y.^2+z.^2).^2.*(-w.^2.*x+x.*y.^2+x.*z.^2+x.^3+w.*y.*z.*2.0).*-2.0,w.*(x.^2+y.^2).*1.0./(w.^2+x.^2+y.^2+z.^2).^2.*4.0,x.*(y.^2+z.^2).*1.0./(w.^2+x.^2+y.^2+z.^2).^2.*4.0,1.0./(w.^2+x.^2+y.^2+z.^2).^2.*(w.^2.*y-x.^2.*y+y.*z.^2+y.^3-w.*x.*z.*2.0).*2.0,1.0./(w.^2+x.^2+y.^2+z.^2).^2.*(w.^2.*z-x.^2.*z+y.^2.*z+z.^3+w.*x.*y.*2.0).*2.0,1.0./(w.^2+x.^2+y.^2+z.^2).^2.*(w.^2.*y-x.^2.*y+y.*z.^2+y.^3+w.*x.*z.*2.0).*2.0,x.*(w.^2+y.^2).*1.0./(w.^2+x.^2+y.^2+z.^2).^2.*-4.0,1.0./(w.^2+x.^2+y.^2+z.^2).^2.*(-w.*x.^2+w.*y.^2+w.*z.^2+w.^3-x.*y.*z.*2.0).*2.0,1.0./(w.^2+x.^2+y.^2+z.^2).^2.*(w.^2.*z-x.^2.*z+y.^2.*z+z.^3-w.*x.*y.*2.0).*2.0,1.0./(w.^2+x.^2+y.^2+z.^2).^2.*(-w.*x.^2+w.*y.^2+w.*z.^2+w.^3+x.*y.*z.*2.0).*-2.0,x.*(w.^2+z.^2).*1.0./(w.^2+x.^2+y.^2+z.^2).^2.*-4.0,y.*(w.^2+x.^2).*1.0./(w.^2+x.^2+y.^2+z.^2).^2.*-4.0,1.0./(w.^2+x.^2+y.^2+z.^2).^2.*(w.^2.*x-x.*y.^2+x.*z.^2+x.^3-w.*y.*z.*2.0).*2.0,1.0./(w.^2+x.^2+y.^2+z.^2).^2.*(w.*x.^2-w.*y.^2+w.*z.^2+w.^3+x.*y.*z.*2.0).*-2.0,1.0./(w.^2+x.^2+y.^2+z.^2).^2.*(w.^2.*x-x.*y.^2+x.*z.^2+x.^3+w.*y.*z.*2.0).*2.0,y.*(x.^2+z.^2).*1.0./(w.^2+x.^2+y.^2+z.^2).^2.*4.0,1.0./(w.^2+x.^2+y.^2+z.^2).^2.*(w.^2.*z+x.^2.*z-y.^2.*z+z.^3-w.*x.*y.*2.0).*2.0,1.0./(w.^2+x.^2+y.^2+z.^2).^2.*(w.*x.^2-w.*y.^2+w.*z.^2+w.^3-x.*y.*z.*2.0).*2.0,1.0./(w.^2+x.^2+y.^2+z.^2).^2.*(w.^2.*z+x.^2.*z-y.^2.*z+z.^3+w.*x.*y.*2.0).*2.0,y.*(w.^2+z.^2).*1.0./(w.^2+x.^2+y.^2+z.^2).^2.*-4.0,z.*(w.^2+x.^2).*1.0./(w.^2+x.^2+y.^2+z.^2).^2.*-4.0,1.0./(w.^2+x.^2+y.^2+z.^2).^2.*(w.*x.^2+w.*y.^2-w.*z.^2+w.^3-x.*y.*z.*2.0).*2.0,1.0./(w.^2+x.^2+y.^2+z.^2).^2.*(w.^2.*x+x.*y.^2-x.*z.^2+x.^3+w.*y.*z.*2.0).*2.0,1.0./(w.^2+x.^2+y.^2+z.^2).^2.*(w.*x.^2+w.*y.^2-w.*z.^2+w.^3+x.*y.*z.*2.0).*-2.0,z.*(w.^2+y.^2).*1.0./(w.^2+x.^2+y.^2+z.^2).^2.*-4.0,1.0./(w.^2+x.^2+y.^2+z.^2).^2.*(w.^2.*y+x.^2.*y-y.*z.^2+y.^3-w.*x.*z.*2.0).*2.0,1.0./(w.^2+x.^2+y.^2+z.^2).^2.*(w.^2.*x+x.*y.^2-x.*z.^2+x.^3-w.*y.*z.*2.0).*2.0,1.0./(w.^2+x.^2+y.^2+z.^2).^2.*(w.^2.*y+x.^2.*y-y.*z.^2+y.^3+w.*x.*z.*2.0).*2.0,z.*(x.^2+y.^2).*1.0./(w.^2+x.^2+y.^2+z.^2).^2.*4.0],[9,4]);
end
end